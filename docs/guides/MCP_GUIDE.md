# MCP (Model Context Protocol) 使用指南

## 🎯 什么是MCP？

**MCP (Model Context Protocol)** 是一个智能协调器，负责管理模型与工具之间的交互循环。它能够：

- 🔄 **自动工具调用循环**：模型调用工具 → 执行工具 → 将结果返回模型 → 继续处理，直到完成
- 📊 **过程可视化**：记录每一步的thinking、工具调用、结果
- 🛡️ **错误处理**：处理工具失败、超时、循环等异常情况
- 🎨 **详细信息展示**：可查看完整的处理过程

## 🆚 MCP vs 传统模式

### 传统模式（单次调用）
```
用户 → 模型 → 工具调用 → 执行 → 显示结果
```
**限制**：只能调用一次工具，模型无法基于工具结果继续思考

### MCP模式（循环调用）
```
用户 → 模型 
      ↓
    思考 → 工具调用1 → 执行 → 结果
      ↓
    思考 → 工具调用2 → 执行 → 结果  
      ↓
    思考 → 最终答案
```
**优势**：模型可以多轮使用工具，逐步解决复杂问题

## 🚀 快速开始

### 第1步：启用MCP模式

1. 打开网页 → **智能对话**页面
2. 在左侧配置区域 → **🔧 启用工具**
3. ✅ 勾选 **"🤖 自动解析工具调用"**
4. ✅ 勾选要使用的工具（如 `calculate`, `get_current_time`）

**MCP会自动激活！**

### 第2步：配置模型系统提示词

```
你是一个智能助手，可以使用工具来帮助用户。

当需要使用工具时，请使用以下格式：
<tool_call>
{"name": "工具名", "arguments": {参数}}
</tool_call>

你可以：
1. 多次调用工具
2. 根据工具结果继续思考
3. 组合多个工具解决问题

可用工具：
- calculate: 计算数学表达式
- get_current_time: 获取当前时间
```

### 第3步：开始对话

发送需要多步骤处理的问题，MCP会自动协调！

## 💡 使用示例

### 示例1：简单计算（单次工具调用）

**用户输入**：
```
帮我算 123 * 456
```

**MCP处理过程**：
```
🔄 第 1 轮处理
├─ 💭 模型思考: "用户要求计算，使用calculate工具"
├─ 🔧 调用工具: calculate
│  └─ 参数: {"expression": "123 * 456"}
├─ ✅ 成功: {"value": 56088}
└─ 💬 最终答案: "123乘以456等于56088"
```

### 示例2：多步骤问题（多轮工具调用）

**用户输入**：
```
现在几点了？然后帮我算从现在到晚上8点还有多少小时
```

**MCP处理过程**：
```
🔄 第 1 轮处理
├─ 💭 模型思考: "先获取当前时间"
├─ 🔧 调用工具: get_current_time
│  └─ 参数: {"timezone": "Asia/Shanghai"}
├─ ✅ 成功: {"time": "2024-12-03 14:30:00"}
└─ ✅ 工具执行完成，继续处理

🔄 第 2 轮处理
├─ 💭 模型思考: "当前是14:30，计算到20:00的时间差"
├─ 🔧 调用工具: calculate
│  └─ 参数: {"expression": "20 - 14.5"}
├─ ✅ 成功: {"value": 5.5}
└─ ✅ 工具执行完成，继续处理

🔄 第 3 轮处理
├─ 💭 模型思考: "已有所有信息，给出答案"
└─ 💬 最终答案: "现在是14:30，距离晚上8点还有5.5小时"
```

### 示例3：工具调用失败处理

**用户输入**：
```
帮我算 10 / 0
```

**MCP处理过程**：
```
🔄 第 1 轮处理
├─ 💭 模型思考: "执行除法运算"
├─ 🔧 调用工具: calculate
│  └─ 参数: {"expression": "10 / 0"}
├─ ❌ 失败: 除零错误
└─ ✅ 工具执行完成，继续处理

🔄 第 2 轮处理
├─ 💭 模型思考: "工具返回错误，需要解释"
└─ 💬 最终答案: "抱歉，无法计算10除以0，因为除数不能为零"
```

## 📋 查看详细信息

每条AI回复右上角有一个 **📋** 按钮（不显眼）：

1. 点击 **📋** 按钮
2. 展开详细信息面板
3. 查看完整的处理过程：
   - 💭 所有thinking内容
   - 🔧 所有工具调用
   - ✅ 工具执行结果
   - ⏱️ 时间戳

**面板样式**：
```
┌─────────────────────────────────────┐
│ 💭 处理过程详情                      │
├─────────────────────────────────────┤
│ 🔄 第 1 轮处理          14:30:15    │
│ ┌───────────────────────────────────┤
│ │ 💭 模型思考           14:30:16    │
│ │ ┌─────────────────────────────────┤
│ │ │ 用户要求计算...                 │
│ │ └─────────────────────────────────┤
│ ├───────────────────────────────────┤
│ │ 🔧 调用工具: calculate 14:30:17   │
│ │ ┌─────────────────────────────────┤
│ │ │ 参数: {"expression": "2+3"}     │
│ │ │ ✅ 成功                         │
│ │ │ {                               │
│ │ │   "expression": "2+3",          │
│ │ │   "value": 5                    │
│ │ │ }                               │
│ │ └─────────────────────────────────┤
│ └───────────────────────────────────┤
│ ✅ 处理完成             14:30:18    │
└─────────────────────────────────────┘
```

## 🔧 MCP配置

### 最大迭代次数

默认最大10轮，可在 `mcp.py` 中修改：

```python
class MCPCoordinator:
    def __init__(self, model_caller, tool_executor):
        self.max_iterations = 10  # 修改这里
```

### 工具调用格式

MCP支持三种格式（详见 AUTO_TOOL_PARSE.md）：

1. **标准JSON格式**（推荐）
```xml
<tool_call>
{"name": "tool_name", "arguments": {...}}
</tool_call>
```

2. **XML属性格式**
```xml
<tool_call name="tool_name" arguments='{...}'/>
```

3. **函数调用格式**
```javascript
tool_name({...})
```

## 📊 MCP事件类型

MCP会发送以下事件（SSE格式）：

| 事件类型 | 说明 | 数据 |
|---------|------|------|
| `iteration_start` | 新迭代开始 | `{iteration, total_messages}` |
| `thinking_extracted` | 提取thinking | `{thinking}` |
| `tool_calls_parsed` | 解析到工具调用 | `{count, calls}` |
| `tool_call_start` | 工具开始执行 | `{name, arguments}` |
| `tool_call_complete` | 工具执行完成 | `{name, success, result}` |
| `tool_call_error` | 工具执行失败 | `{name, error}` |
| `iteration_complete` | 迭代完成 | `{iteration, has_tool_calls}` |
| `max_iterations_reached` | 达到最大轮数 | `{max_iterations}` |
| `done` | 全部完成 | `{}` |

## 🔄 MCP工作流程

```
┌─────────────────────────────────────────┐
│              用户发送消息                │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│         MCP协调器初始化                  │
│   - 准备消息历史                         │
│   - 准备工具列表                         │
│   - 设置参数                             │
└──────────────┬──────────────────────────┘
               ↓
┌─────────────────────────────────────────┐
│    第N轮迭代 (N=1 to max_iterations)    │
├─────────────────────────────────────────┤
│ 1. 发送 iteration_start 事件            │
│ 2. 调用模型（流式）                      │
│    ├─ 发送 thinking 状态                │
│    ├─ 接收并转发内容                     │
│    └─ 收集完整输出                       │
│ 3. 提取thinking内容                      │
│    └─ 发送 thinking_extracted 事件      │
│ 4. 解析工具调用                          │
│    └─ 发送 tool_calls_parsed 事件       │
└──────────────┬──────────────────────────┘
               ↓
        ┌──────────────┐
        │ 有工具调用？  │
        └──┬────────┬───┘
          是│       │否
            ↓       ↓
    ┌───────────┐  ┌──────────┐
    │执行工具    │  │结束循环   │
    ├───────────┤  └──────────┘
    │FOR 每个工具│
    │├ 发送 tool_call_start
    │├ 执行工具
    │├ 发送 tool_call_complete/error
    │└ 将结果添加到消息历史
    └──────┬────┘
           ↓
    ┌──────────────┐
    │继续下一轮迭代 │
    └──────────────┘
```

## 🛠️ 技术细节

### 后端架构

**文件**: `mcp.py`

```python
class MCPCoordinator:
    """MCP协调器核心类"""
    
    def coordinate_stream(self, messages, tools, params, auto_parse):
        """
        主协调函数
        - 管理迭代循环
        - 调用模型
        - 解析工具调用
        - 执行工具
        - 管理消息历史
        """
        
    def _parse_tool_calls(self, content):
        """解析多种格式的工具调用"""
        
    def _extract_thinking(self, content):
        """提取thinking内容"""
        
    def _clean_content(self, content):
        """清理标签，获取纯文本"""
```

### 前端架构

**文件**: `app.js`

```javascript
// MCP模式检测
const autoParseEnabled = elements.autoParseTools.checked;
const endpoint = autoParseEnabled ? '/api/chat/mcp' : '/api/chat/stream';

// MCP事件处理
function handleMCPEvent(event, messageBody, ...) {
    // 根据事件类型更新UI
    // 记录到详情面板
}

// 详情面板管理
function addDetailsItem(container, item) {
    // 添加thinking、工具调用、结果等
}
```

## ⚠️ 注意事项

### 性能考虑

1. **迭代次数限制**：默认10轮，避免无限循环
2. **工具超时**：每个工具调用有30秒超时
3. **消息历史**：每轮都会增加消息，注意token消耗

### 最佳实践

1. **清晰的系统提示**：告诉模型如何使用工具
2. **工具描述完整**：让模型知道何时使用哪个工具
3. **错误处理**：工具应该返回明确的错误信息
4. **合理的工具粒度**：不要让工具太复杂

### 故障排查

**Q: MCP没有激活？**
- 确认"自动解析工具调用"开关已启用
- 检查浏览器控制台的网络请求（应该是 `/api/chat/mcp`）

**Q: 工具没有被调用？**
- 查看详情面板，检查是否解析到工具调用
- 确认模型输出的格式正确
- 检查系统提示词是否清晰

**Q: 陷入循环？**
- 检查是否达到最大迭代次数（详情面板会显示警告）
- 优化系统提示词，让模型知道何时停止

**Q: 详情按钮不显示？**
- 详情按钮只在MCP模式下、且有处理过程时显示
- 确认使用的是MCP端点而非传统端点

## 📚 相关文档

- **工具API文档**: `TOOL_API.md`
- **自动解析文档**: `AUTO_TOOL_PARSE.md`
- **快速入门**: `QUICKSTART_TOOLS.md`
- **更新日志**: `CHANGELOG.md` (v2.7)

## 🔮 未来计划

- [ ] 工具调用可视化流程图
- [ ] MCP性能统计和监控
- [ ] 支持并行工具调用
- [ ] 工具调用缓存
- [ ] 更智能的循环检测

---

**开始使用MCP，让AI更智能地使用工具！** 🚀

